<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>¡Retrato Completo!</title>
  
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      background: #000; 
    }
    video {
      position: absolute;
      left: -9999px;
    }
    canvas {
      z-index: 100;
    }
  </style>
</head>

<body>
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

  <script>
    // --- Variables de Detección Facial ---
    let videoEl;
    let faceapi;
    let detections = [];
    let modeloListo = false;
    
    // --- Variables de Huella Digital (IP) ---
    let ip = "0.0.0.0";
    let valores;
    let index = 0;

    function setup() {
      createCanvas(800, 800);
      
      // ----- ¡CAMBIO DE VELOCIDAD! -----
      frameRate(3); // <-- MÁS LENTO (antes era 10)
      
      // --- 1. Configurar Cámara ---
      videoEl = createCapture({
        video: { facingMode: "user", width: 800, height: 800 },
        audio: false
      }); 
      videoEl.elt.muted = true; 
      videoEl.size(width, height);

      // --- 2. Crear Cadena de Carga ---
      videoEl.elt.onloadedmetadata = () => {
        console.log("PASO 1: 🎥 Cámara lista.");
        videoEl.play(); 
        
        console.log("PASO 2: 🧠 Cargando modelo de rostro...");
        const options = {
          withLandmarks: true,
          withExpressions: false,
          withDescriptors: false
        };
        faceapi = ml5.faceApi(videoEl.elt, options, modelReady);
      }

      textAlign(CENTER);
      textSize(20);
      fill(255);
    }

    // --- 3. Cargar IP ---
    function modelReady() {
      console.log("PASO 3: ✅ Modelo de rostro cargado.");
      modeloListo = true;
      
      console.log("PASO 4: 🔢 Buscando huella IP...");
      fetch("https://api64.ipify.org?format=json")
        .then(res => res.json())
        .then(data => {
          ip = data.ip;
          valores = ip.split(".").map(n => int(n));
          console.log("PASO 5: ✅ IP cargada:", ip);
        })
        .catch(err => {
          console.error("Error al obtener IP:", err);
          valores = [1, 2, 3, 4]; 
        });

      faceapi.detect(videoEl.elt, gotResults);
    }

    function gotResults(err, result) {
      if (err) {
        console.error(err);
        return;
      }
      detections = result;
      faceapi.detect(videoEl.elt, gotResults);
    }
    
    // --- Función DRAW principal ---
    function draw() {
      
      // --- Comprobaciones de Carga ---
      if (videoEl.elt.videoWidth === 0) {
        background(0);
        fill(255);
        text("PASO 1: 🎥 Iniciando cámara...", width / 2, height / 2);
        return;
      }
      if (!modeloListo) {
        background(0);
        fill(255);
        text("PASO 2: 🧠 Cargando modelo de rostro...", width / 2, height / 2);
        return;
      }
      if (!valores) {
        background(0);
        fill(255);
        text("PASO 4: 🔢 Cargando huella IP...", width / 2, height / 2);
        return;
      }

      // 1. Dibuja el video de la cámara (en modo espejo)
      push();
      translate(width, 0);
      scale(-1, 1);
      image(videoEl, 0, 0, width, height);
      pop();
      
      // 2. Dibuja las figuras ENCIMA
      if (detections.length > 0) {
        const points = detections[0].landmarks.positions;
        let num = valores[index % valores.length] % 10;
        
        switch(num){
          case 0: estilo0(points); break;
          case 1: estilo1(points); break;
          case 2: estilo2(points); break;
          case 3: estilo3(points); break;
          case 4: estilo4(points); break;
          case 5: estilo5(points); break;
          case 6: estilo6(points); break;
          case 7: estilo7(points); break;
          case 8: estilo8(points); break;
          case 9: estilo9(points); break;
        }
        
        index++; 

      } else {
        fill(255);
        text("Mira hacia la cámara 👀", width / 2, height / 2);
      }

      // 3. Texto poético
      fill(255, 200);
      textAlign(CENTER);
      textSize(16);
      text("Tu huella digital visual: " + ip, width/2, height - 30);
    }

    function windowResized() {
      resizeCanvas(windowWidth < 700 ? windowWidth : 640, windowHeight < 500 ? windowHeight : 480);
    }

    // ---------------------------------------------------------------
    // --- ESTILOS ADAPTADOS (¡CON MÁS FIGURAS!) ---
    // ---------------------------------------------------------------

    function estilo0(points) {
      let colores = ['#64B5F680','#90CAF980','#4FC3F780','#29B6F680','#0288D180'];
      
      // ----- ¡CAMBIO DE COBERTURA! -----
      for (let i=0; i < 15; i++){ // <-- MÁS FIGURAS (antes era 2)
        let p = random(points); 
        fill(random(colores));
        noStroke();
        ellipse(width - p.x, p.y, random(20, 100)); // <-- Un poco más pequeño
      }
    }

    function estilo1(points) {
      let colores = ['#FF6EC780','#E040FB80','#BA68C880','#8E24AA80','#D500F980'];
      for (let i=0; i < 15; i++){ // <-- MÁS FIGURAS (antes era 2)
        let p = random(points);
        fill(random(colores));
        noStroke();
        push();
        translate(width - p.x, p.y); 
        rotate(random(TWO_PI));
        rect(0,0,random(20,80),random(10,40),10);
        pop();
      }
    }

    function estilo2(points) {
      let colores = ['#FFEB3B70','#FFF59D70','#FFD74070','#FBC02D70'];
      for (let i=0; i < 15; i++){ // <-- MÁS FIGURAS (antes era 2)
        let p = random(points);
        fill(random(colores));
        noStroke();
        let x = width - p.x; 
        let y = p.y;         
        beginShape();
        for(let j=0;j<5;j++){
          let angle = TWO_PI/5*j + frameCount*0.01;
          vertex(x+cos(angle)*random(20,40), y+sin(angle)*random(20,40));
        }
        endShape(CLOSE);
      }
    }

    function estilo3(points) {
      let colores = ['#FF8A6580','#FF704380','#E64A1980','#D8431580'];
      for(let i=0; i < 15; i++){ // <-- MÁS FIGURAS (antes era 2)
        let p = random(points);
        fill(random(colores));
        noStroke();
        ellipse(width - p.x, p.y, random(30,80));
      }
    }

    function estilo4(points) {
      let colores = ['#A5D6A780','#81C78480','#66BB6A80','#4CAF5080'];
      for(let i=0; i < 15; i++){ // <-- MÁS FIGURAS (antes era 2)
        let p = random(points);
        fill(random(colores));
        noStroke();
        push();
        translate(width - p.x, p.y);
        rotate(frameCount*0.02);
        rect(0,0,random(40,70),random(20,50));
        pop();
      }
    }

    function estilo5(points) {
      let colores = ['#80DEEA80','#26C6DA80','#00ACC180','#00838F80'];
      for(let i=0; i < 15; i++){ // <-- MÁS FIGURAS (antes era 2)
        let p = random(points);
        fill(random(colores));
        noStroke();
        let x = width - p.x;
        let y = p.y;
        triangle(x,y,x+random(30,60),y+random(-30,30),x+random(-40,40),y+random(30,60));
      }
    }

    function estilo6(points) {
      let colores = ['#F5F5F580','#BDBDBD80','#9E9E9E80','#75757580'];
      for(let i=0; i < 20; i++){ // <-- MÁS FIGURAS (antes era 3)
        let p = random(points);
        fill(random(colores));
        noStroke();
        rect(width - p.x, p.y, random(10,50), random(10,50));
      }
    }

    function estilo7(points) {
      let colores = ['#FFB6C180','#F48FB180','#F0629280','#EC407A80'];
      for(let i=0; i < 15; i++){ // <-- MÁS FIGURAS (antes era 2)
        let p = random(points);
        fill(random(colores));
        noStroke();
        let x = width - p.x;
        let y = p.y;
        beginShape();
        for(let j=0;j<6;j++){
          let angle=TWO_PI/6*j;
          vertex(x+cos(angle)*random(20,40), y+sin(angle)*random(20,40));
        }
        endShape(CLOSE);
      }
    }

    function estilo8(points) {
      let colores = ['#FFF9C480','#FFF59D80','#FFEE5880','#FFF17680'];
      let c1=color(random(colores));
      let c2=color(random(colores));
      for(let j=0; j < 15; j++){ // <-- MÁS FIGURAS (antes era 2)
        let p = random(points);
        fill(lerpColor(c1,c2,j/10));
        noStroke();
        ellipse(width - p.x, p.y, random(30,80));
      }
    }

    function estilo9(points) {
      let colores = ['#BBDEFB80','#64B5F680','#2196F380','#1976D280'];
      for(let i=0; i < 15; i++){ // <-- MÁS FIGURAS (antes era 2)
        let p = random(points);
        fill(random(colores));
        noStroke();
        push();
        translate(width - p.x, p.y);
        rotate(random(TWO_PI));
        beginShape();
        for(let j=0;j<random(5,8);j++){
          vertex(cos(j*TWO_PI/6)*random(20,50), sin(j*TWO_PI/6)*random(20,50));
        }
        endShape(CLOSE);
        pop();
      }
    }
  </script>
</body>
</html>
