<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Retrato de Huella Digital</title>
  
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      background: #000; 
    }
    video {
      /* Oculta el <video> original a la fuerza */
      position: absolute;
      left: -9999px;
    }
    canvas {
      /* Trae el <canvas> de p5.js al frente */
      z-index: 100;
    }
  </style>
</head>

<body>
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

  <script>
    // --- Variables de Detecci√≥n Facial ---
    let videoEl;
    let faceapi;
    let detections = [];
    let modeloListo = false;
    
    // --- Variables de Huella Digital (IP) ---
    let ip = "0.0.0.0";
    let valores;
    let index = 0;

    function setup() {
      createCanvas(800, 800);
      frameRate(10); // üéµ Un ritmo vivo
      
      // --- Configurar C√°mara y FaceAPI ---
      videoEl = createCapture({
        video: { facingMode: "user", width: 800, height: 800 },
        audio: false
      }); 
      videoEl.elt.muted = true; 
      videoEl.elt.onloadedmetadata = () => {
        console.log("üé• C√°mara lista (metadata cargada)");
        videoEl.play(); 
      }
      videoEl.size(width, height);
      // El CSS oculta el <video>

      const options = {
        withLandmarks: true,
        withExpressions: false,
        withDescriptors: false
      };
      faceapi = ml5.faceApi(videoEl.elt, options, modelReady);

      // --- Configurar Huella Digital (IP) ---
      fetch("https://api64.ipify.org?format=json")
        .then(res => res.json())
        .then(data => {
          ip = data.ip;
          valores = ip.split(".").map(n => int(n));
          console.log("‚úÖ IP cargada:", ip);
        })
        .catch(err => {
          console.error("Error al obtener IP:", err);
          valores = [1, 2, 3, 4]; // Valores por defecto si falla
        });
      
      // --- Configuraci√≥n General ---
      textAlign(CENTER);
      textSize(20);
      fill(255);
    }

    // --- Funciones de Detecci√≥n Facial ---
    function modelReady() {
      console.log("‚úÖ Modelo cargado correctamente");
      modeloListo = true;
      faceapi.detect(videoEl.elt, gotResults);
    }

    function gotResults(err, result) {
      if (err) {
        console.error(err);
        return;
      }
      detections = result;
      faceapi.detect(videoEl.elt, gotResults);
    }
    
    // --- Funci√≥n DRAW principal ---
    function draw() {
      // 1. Fondo con memoria (de tu proyecto IP)
      noStroke();
      fill(10, 10, 20, 30);
      rect(0, 0, width, height);

      // --- Comprobaciones de Carga ---
      if (videoEl.elt.videoWidth === 0) {
        fill(255);
        text("üé• Iniciando c√°mara...", width / 2, height / 2);
        return;
      }
      if (!modeloListo) {
        fill(255);
        text("üß† Cargando modelo de rostro...", width / 2, height / 2);
        return;
      }
      if (!valores) {
        fill(255);
        text("üî¢ Cargando huella IP...", width / 2, height / 2);
        return;
      }

      // --- ¬°LA MAGIA OCURRE AQU√ç! ---
      
      // 3. Comprobar si hay una cara
      if (detections.length > 0) {
        // ¬°S√≠ hay cara! Obtenemos los 68 puntos
        const points = detections[0].landmarks.positions;
        
        // 4. Decidir qu√© estilo dibujar (seg√∫n tu IP)
        let num = valores[index % valores.length] % 10;
        
        // 5. Llamar a la funci√≥n de estilo, PAS√ÅNDOLE los puntos de la cara
        switch(num){
          case 0: estilo0(points); break;
          case 1: estilo1(points); break;
          case 2: estilo2(points); break;
          case 3: estilo3(points); break;
          case 4: estilo4(points); break;
          case 5: estilo5(points); break;
          case 6: estilo6(points); break;
          case 7: estilo7(points); break;
          case 8: estilo8(points); break;
          case 9: estilo9(points); break;
        }
        
        index++; // Avanzamos al siguiente n√∫mero de la IP

      } else {
        // No hay cara, mostrar mensaje
        fill(255);
        text("Mira hacia la c√°mara üëÄ", width / 2, height / 2);
      }

      // 6. Texto po√©tico
      fill(255, 200);
      textAlign(CENTER);
      textSize(16);
      text("Tu huella digital visual: " + ip, width/2, height - 30);
    }

    function windowResized() {
      resizeCanvas(windowWidth < 700 ? windowWidth : 640, windowHeight < 500 ? windowHeight : 480);
    }

    // ---------------------------------------------------------------
    // --- ESTILOS ADAPTADOS AL ROSTRO (TU C√ìDIGO MODIFICADO) ---
    // ---------------------------------------------------------------
    // Ahora, cada funci√≥n acepta 'points' (los 68 puntos de la cara)

    function estilo0(points) {
      let colores = ['#64B5F680','#90CAF980','#4FC3F780','#29B6F680','#0288D180'];
      for (let i=0; i < 2; i++){ // Reducido para que no se sature
        let p = random(points); // Tomamos un punto ALEATORIO de la cara
        fill(random(colores));
        // Dibujamos en la posici√≥n del punto (reflejado)
        ellipse(width - p.x, p.y, random(20, 120));
      }
    }

    function estilo1(points) {
      let colores = ['#FF6EC780','#E040FB80','#BA68C880','#8E24AA80','#D500F980'];
      for (let i=0; i < 2; i++){
        let p = random(points);
        fill(random(colores));
        push();
        translate(width - p.x, p.y); // Nos movemos al punto de la cara (reflejado)
        rotate(random(TWO_PI));
        rect(0,0,random(20,100),random(10,50),10);
        pop();
      }
    }

    function estilo2(points) {
      let colores = ['#FFEB3B70','#FFF59D70','#FFD74070','#FBC02D70'];
      for (let i=0; i < 2; i++){
        let p = random(points);
        fill(random(colores));
        let x = width - p.x; // <-- Posici√≥n X reflejada
        let y = p.y;         // <-- Posici√≥n Y
        beginShape();
        for(let j=0;j<5;j++){
          let angle = TWO_PI/5*j + frameCount*0.01;
          vertex(x+cos(angle)*random(20,50), y+sin(angle)*random(20,50));
        }
        endShape(CLOSE);
      }
    }

    function estilo3(points) {
      let colores = ['#FF8A6580','#FF704380','#E64A1980','#D8431580'];
      for(let i=0; i < 2; i++){
        let p = random(points);
        fill(random(colores));
        ellipse(width - p.x, p.y, random(30,90));
      }
    }

    function estilo4(points) {
      let colores = ['#A5D6A780','#81C78480','#66BB6A80','#4CAF5080'];
      for(let i=0; i < 2; i++){
        let p = random(points);
        fill(random(colores));
        push();
        translate(width - p.x, p.y);
        rotate(frameCount*0.02);
        rect(0,0,random(40,80),random(20,60));
        pop();
      }
    }

    function estilo5(points) {
      let colores = ['#80DEEA80','#26C6DA80','#00ACC180','#00838F80'];
      for(let i=0; i < 2; i++){
        let p = random(points);
        fill(random(colores));
        let x = width - p.x;
        let y = p.y;
        triangle(x,y,x+random(30,70),y+random(-30,30),x+random(-40,40),y+random(30,70));
      }
    }

    function estilo6(points) {
      let colores = ['#F5F5F580','#BDBDBD80','#9E9E9E80','#75757580'];
      for(let i=0; i < 3; i++){ // Un poco m√°s de rect√°ngulos
        let p = random(points);
        fill(random(colores));
        rect(width - p.x, p.y, random(10,60), random(10,60));
      }
    }

    function estilo7(points) {
      let colores = ['#FFB6C180','#F48FB180','#F0629280','#EC407A80'];
      for(let i=0; i < 2; i++){
        let p = random(points);
        fill(random(colores));
        let x = width - p.x;
        let y = p.y;
        beginShape();
        for(let j=0;j<6;j++){
          let angle=TWO_PI/6*j;
          vertex(x+cos(angle)*random(20,50), y+sin(angle)*random(20,50));
        }
        endShape(CLOSE);
      }
    }

    function estilo8(points) {
      let colores = ['#FFF9C480','#FFF59D80','#FFEE5880','#FFF17680'];
      let c1=color(random(colores));
      let c2=color(random(colores));
      for(let j=0; j < 2; j++){
        let p = random(points);
        fill(lerpColor(c1,c2,j/10));
        ellipse(width - p.x, p.y, random(30,100));
      }
    }

    function estilo9(points) {
      let colores = ['#BBDEFB80','#64B5F680','#2196F380','#1976D280'];
      for(let i=0; i < 2; i++){
        let p = random(points);
        fill(random(colores));
        push();
        translate(width - p.x, p.y);
        rotate(random(TWO_PI));
        beginShape();
        for(let j=0;j<random(5,8);j++){
          vertex(cos(j*TWO_PI/6)*random(20,60), sin(j*TWO_PI/6)*random(20,60));
        }
        endShape(CLOSE);
        pop();
      }
    }

  </script>
</body>
</html>
