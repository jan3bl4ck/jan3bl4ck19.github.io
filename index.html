<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Huella Digital Fundida</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    video { display: none !important; }
    canvas { display: block; }
    #downloadBtn { position: absolute; top: 10px; left: 10px; z-index: 10; display: none; }
  </style>
</head>
<body>

<button id="downloadBtn">Descargar retrato</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
<script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

<script>
let videoEl;
let faceapi;
let detections = [];
let modeloListo = false;

let ip = "0.0.0.0";
let valores;
let index = 0;

let stableFrames = 0;
let freezeThreshold = 30; // frames estables antes de congelar
let isFrozen = false;

function setup() {
  createCanvas(windowWidth, windowHeight);
  background(15);
  frameRate(30);

  // Captura de cámara
  videoEl = createCapture({ video: { facingMode: "user" }, audio: false });
  videoEl.size(width, height);
  videoEl.elt.muted = true;

  const options = { withLandmarks: true, withExpressions: false, withDescriptors: false };
  faceapi = ml5.faceApi(videoEl.elt, options, modelReady);

  // Obtener IP real
  fetch("https://api64.ipify.org?format=json")
    .then(res => res.json())
    .then(data => {
      ip = data.ip;
      valores = ip.split(".").map(n => int(n));
    });

  let btn = select('#downloadBtn');
  btn.mousePressed(() => saveCanvas('huella_digital_fundida', 'png'));
}

function modelReady() {
  modeloListo = true;
  faceapi.detect(videoEl.elt, gotResults);
}

function gotResults(err, result) {
  if (err) { console.error(err); return; }
  detections = result;
  faceapi.detect(videoEl.elt, gotResults);
}

function draw() {
  background(15, 15, 20, 40); // fondo leve para estela poética

  if (!modeloListo || !valores) return;

  // Si no hay rostro, nada que hacer
  if (detections.length > 0) {
    let puntos = detections[0].landmarks.positions;

    // Detectamos estabilidad de rostro
    let movement = frameMovement(puntos);
    if (movement < 2) stableFrames++;
    else stableFrames = 0;

    // Congelar si estable
    if (stableFrames > freezeThreshold) isFrozen = true;

    // Dibujar figuras solo si no está congelado
    if (!isFrozen) {
      for (let p of puntos) {
        let x = width - p.x;
        let y = p.y;

        // Elegir estilo según IP
        let num = valores[index % valores.length] % 10;
        drawStyle(num, x, y);
      }
      index++;
    } else {
      select('#downloadBtn').show();
    }
  }
}

// Función simple para medir movimiento entre frames
let lastPositions = null;
function frameMovement(puntos) {
  if (!lastPositions) {
    lastPositions = puntos.map(p => ({x: p.x, y: p.y}));
    return Infinity;
  }
  let sum = 0;
  for (let i=0;i<puntos.length;i++){
    sum += dist(puntos[i].x, puntos[i].y, lastPositions[i].x, lastPositions[i].y);
  }
  lastPositions = puntos.map(p => ({x: p.x, y: p.y}));
  return sum / puntos.length;
}

// -------------------- Estilos --------------------
function drawStyle(num, x, y){
  switch(num){
    case 0: estilo0(x,y); break;
    case 1: estilo1(x,y); break;
    case 2: estilo2(x,y); break;
    case 3: estilo3(x,y); break;
    case 4: estilo4(x,y); break;
    case 5: estilo5(x,y); break;
    case 6: estilo6(x,y); break;
    case 7: estilo7(x,y); break;
    case 8: estilo8(x,y); break;
    case 9: estilo9(x,y); break;
  }
}

// Cada estilo ahora dibuja en coordenadas del rostro
function estilo0(x,y){
  let colores = ['#64B5F6','#90CAF9','#4FC3F7','#29B6F6','#0288D1'];
  fill(random(colores) + "80");
  ellipse(x + random(-15,15), y + random(-15,15), random(10,30));
}
function estilo1(x,y){
  let colores = ['#FF6EC7','#E040FB','#BA68C8','#8E24AA','#D500F9'];
  fill(random(colores) + "80");
  push(); translate(x,y); rotate(random(TWO_PI));
  rect(0,0,random(5,20),random(5,20),5); pop();
}
function estilo2(x,y){
  let colores = ['#FFEB3B','#FFF59D','#FFD740','#FBC02D'];
  fill(random(colores) + "80");
  ellipse(x+random(-10,10), y+random(-10,10), random(8,25));
}
function estilo3(x,y){
  let colores = ['#FF8A65','#FF7043','#E64A19','#D84315'];
  fill(random(colores) + "80");
  ellipse(x + random(-12,12), y + random(-12,12), random(10,25));
}
function estilo4(x,y){
  let colores = ['#A5D6A7','#81C784','#66BB6A','#4CAF50'];
  fill(random(colores) + "80");
  rect(x + random(-10,10), y + random(-10,10), random(10,30), random(10,30));
}
function estilo5(x,y){
  let colores = ['#80DEEA','#26C6DA','#00ACC1','#00838F'];
  fill(random(colores) + "80");
  triangle(x,y,x+random(10,20),y+random(-10,10),x+random(-10,10),y+random(10,20));
}
function estilo6(x,y){
  let colores = ['#F5F5F5','#BDBDBD','#9E9E9E','#757575'];
  fill(random(colores) + "80");
  rect(x+random(-10,10), y+random(-10,10), random(5,20), random(5,20));
}
function estilo7(x,y){
  let colores = ['#FFB6C1','#F48FB1','#F06292','#EC407A'];
  fill(random(colores) + "80");
  ellipse(x+random(-10,10),y+random(-10,10), random(8,20));
}
function estilo8(x,y){
  let colores = ['#FFF9C4','#FFF59D','#FFEE58','#FFF176'];
  fill(lerpColor(color(random(colores)), color(random(colores)), random(1)) + "80");
  ellipse(x+random(-10,10),y+random(-10,10), random(8,25));
}
function estilo9(x,y){
  let colores = ['#BBDEFB','#64B5F6','#2196F3','#1976D2'];
  fill(random(colores) + "80");
  ellipse(x+random(-10,10), y+random(-10,10), random(8,25));
}

function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>
